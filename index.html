<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WITH RESPECT TO MEHMED GRESIYENKO 2025</title>
  <style>
    body { font-family: sans-serif; background:#fff; color:#000; display:flex; flex-direction:column; align-items:center; padding:10px; margin:0; }
    h2 { text-align:center; font-size:18px; margin:8px 0; }

    #graphToggle { height:28px; font-size:13px; font-weight:bold; padding:0 14px; cursor:pointer; }
    #xzRow { display:flex; align-items:center; justify-content:center; gap:6px; margin:5px 0; }
    .flag { width:80px; height:80px; display:flex; align-items:center; justify-content:center; font-size:64px; line-height:1; }

    #pairs { display:flex; flex-wrap:nowrap; overflow-x:auto; margin:8px 0; width:100%; max-width:420px; }
    .pair-btn { padding:8px 12px; margin:4px; border:none; border-radius:6px; background:#eee; cursor:pointer; font-size:14px; flex:0 0 auto; }
    .pair-btn.active { background:#333; color:#fff; }

    #chart { width:100%; max-width:400px; max-height:300px; }

    #topbar { width:100%; max-width:420px; display:flex; justify-content:space-between; gap:6px; }
    #time, #price { font-size:12px; font-weight:bold; padding:4px 8px; border-radius:4px; min-width:80px; text-align:center; }
    #time { background:#000; color:#fff; margin-right:auto; }
    #price { background:#999; color:#fff; margin-left:auto; }

    #xzRowWrap { width:100%; max-width:420px; position:relative; margin-top:1px; }
    #numbersTop { display:flex; flex-wrap:nowrap; justify-content:flex-end; overflow-x:hidden; width:100%; position:relative; padding:4px 0; }
    .num-box { flex:0 0 22px; height:22px; display:flex; justify-content:center; align-items:center; margin:1px; color:#fff; font-size:12px; border-radius:4px; }
    .worm-line { position:absolute; height:3px; border-top:3px solid; z-index:5; }

    #analysisBoxes { width:100%; max-width:420px; border-top:2px solid #000; margin-top:2px; position:relative; }
    .row { position:relative; display:flex; align-items:center; justify-content:flex-start; height:30px; border-bottom:2px solid #000; font-size:11px; font-weight:700; padding-left:6px; }
    .normalBlue   { color:#0b57d0; }
    .abnormalBlue { color:#0b57d0; background:#cce0ff; }
    .abnormalRed  { color:#d93025; background:#ffd6d6; }
    .normalRed    { color:#d93025; }

    #verticalLine { position:absolute; top:0; bottom:0; width:1.25px; background:#000; }

    .calc-box  { position:absolute; width:22px; height:22px; border-radius:4px; color:#fff; font-size:12px; font-weight:700; display:flex; align-items:center; justify-content:center; top:2px; }
    .calc-worm { position:absolute; height:3px; border-top:3px solid; z-index:4; }
  </style>
</head>
<body>
  <h2>WITH RESPECT TO MEHMED GRESIYENKO 2025</h2>

  <div id="xzRow">
    <span class="flag">ðŸ‡¹ðŸ‡·</span>
    <span class="flag">ðŸ‡µðŸ‡¸</span>
    <button id="graphToggle" onclick="toggleGraph()">XZ</button>
    <span class="flag">ðŸ‡®ðŸ‡©</span>
    <span class="flag">ðŸ‡µðŸ‡¸</span>
  </div>

  <div id="pairs">
    <button class="pair-btn active" onclick="selectPair(this, 'R_100')">Volatility 100</button>
    <button class="pair-btn" onclick="selectPair(this, 'R_75')">Volatility 75</button>
    <button class="pair-btn" onclick="selectPair(this, 'R_50')">Volatility 50</button>
    <button class="pair-btn" onclick="selectPair(this, 'R_25')">Volatility 25</button>
    <button class="pair-btn" onclick="selectPair(this, 'R_10')">Volatility 10</button>
  </div>

  <div id="topbar">
    <div id="time">GMT 00:00:00</div>
    <div id="price">0,00</div>
  </div>

  <div id="chartContainer" style="position:relative; width:100%; max-width:400px;">
    <canvas id="chart"></canvas>
  </div>

  <div id="xzRowWrap">
    <div id="numbersTop"></div>
  </div>

  <div id="analysisBoxes">
    <div class="row normalBlue"   id="rowNB"></div>
    <div class="row abnormalBlue" id="rowAB"></div>
    <div class="row abnormalRed"  id="rowAR"></div>
    <div class="row normalRed"    id="rowNR"></div>
    <div id="verticalLine"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    let ws;
    let prices=[], digits=[], decimalDigits=[], combinedDigits=[];
    let wormLinesTop=[];
    let numColors=[];
    let currentPair='R_100', currentGraph='XZ';

    function toggleGraph(){
      if(currentGraph==='XZ') currentGraph='ZZ';
      else if(currentGraph==='ZZ') currentGraph='Z.Z';
      else currentGraph='XZ';
      document.getElementById('graphToggle').innerText=currentGraph;
      chart.update();
      renderCalcBubbles();
    }

    const ctx=document.getElementById('chart').getContext('2d');
    const chart=new Chart(ctx,{
      type:'line',
      data:{labels:Array.from({length:11},(_,i)=>(i+1).toString()),datasets:[{
        data:Array(11).fill(null),
        borderColor:'black',
        borderWidth:1.5,
        backgroundColor:'rgba(0,0,0,0.05)',
        pointBackgroundColor:Array(11).fill('black'),
        pointRadius:2,
        pointHoverRadius:3
      }]},
      options:{plugins:{legend:{display:false},tooltip:{enabled:false}},scales:{y:{beginAtZero:false}},animation:false},
      plugins:[{afterDatasetsDraw(chart){
        const {ctx}=chart;
        const meta=chart.getDatasetMeta(0);

        ctx.font='900 14px sans-serif';
        ctx.textAlign='center';
        ctx.textBaseline='bottom';

        const decs=decimalDigits.slice(-11);
        const digs=digits.slice(-11);
        const combs=combinedDigits.slice(-11);
        const colors=numColors.slice(-11);
        const worms=wormLinesTop.slice(-11);

        meta.data.forEach((pt,i)=>{
          let t='';
          if(currentGraph==='XZ') t=decs[i]||'';
          else if(currentGraph==='ZZ') t=digs[i]||'';
          else t=(combs[i]||'').replace(',', '.');

          if(pt && pt.x!==undefined){
            ctx.fillStyle = (colors[i]||'#000');
            ctx.fillText(t, pt.x, pt.y - 2);

            const wormColor = worms[i];
            if(wormColor==='blue' || wormColor==='red'){
              ctx.strokeStyle = wormColor;
              ctx.lineWidth = 3;
              ctx.beginPath();
              ctx.moveTo(pt.x - 5, pt.y - 2);
              ctx.lineTo(pt.x + 5, pt.y - 2);
              ctx.stroke();
            }
          }
        });

        const last = meta.data[meta.data.length-1];
        if(last && last.x!==undefined){
          ctx.strokeStyle='black';
          ctx.lineWidth=1.5;
          ctx.beginPath();
          ctx.moveTo(chart.scales.x.left, last.y);
          ctx.lineTo(last.x, last.y);
          ctx.stroke();
        }
      }}]
    });

    function selectPair(el,pair){
      currentPair=pair;
      document.querySelectorAll('.pair-btn').forEach(b=>b.classList.remove('active'));
      el.classList.add('active');
      if(ws) ws.close();
      prices=[];digits=[];decimalDigits=[];combinedDigits=[];wormLinesTop=[];numColors=[];
      document.getElementById('numbersTop').innerHTML='';
      ['rowNB','rowAB','rowAR','rowNR'].forEach(id=>{
        document.getElementById(id).innerHTML='';
      });
      startWS();
    }

    function updateWorm(){
      if(prices.length<20) return;
      const last20=prices.slice(-20);
      const max=Math.max(...last20.slice(0,-1));
      const min=Math.min(...last20.slice(0,-1));
      const last=last20[last20.length-1];
      let color='lightgreen';
      if(last>max) color='blue';
      else if(last<min) color='red';
      wormLinesTop.push(color);
      if(wormLinesTop.length>20) wormLinesTop.shift();
    }

    function renderWormLines(containerId,wormArray){
      const c=document.getElementById(containerId);
      c.querySelectorAll('.worm-line').forEach(e=>e.remove());
      const boxes=c.querySelectorAll('.num-box');
      boxes.forEach((box,idx)=>{
        if(!wormArray[idx]) return;
        const line=document.createElement('div');
        line.className='worm-line';
        line.style.width=box.offsetWidth+'px';
        line.style.left=box.offsetLeft+'px';
        line.style.top=(box.offsetTop+box.offsetHeight+0.2)+'px';
        line.style.borderTopColor=wormArray[idx];
        c.appendChild(line);
      });
    }

    function placeVerticalLine(){
      const row=document.getElementById('numbersTop');
      const vLine=document.getElementById('verticalLine');
      const boxes=row.querySelectorAll('.num-box');
      if(boxes.length<7) return;
      const b6=boxes[boxes.length-6];
      const b7=boxes[boxes.length-7];
      const r6=b6.getBoundingClientRect();
      const r7=b7.getBoundingClientRect();
      const rA=document.getElementById('analysisBoxes').getBoundingClientRect();
      const midViewportX = (r7.right + r6.left) / 2;
      const leftInside = midViewportX - rA.left;
      vLine.style.left = leftInside + 'px';
    }

    // ðŸ”¹ GÃœNCELLENEN renderCalcBubbles
    function renderCalcBubbles(){
      ['rowNB','rowAB','rowAR','rowNR'].forEach(id=>{
        const rowEl=document.getElementById(id);
        rowEl.querySelectorAll('.calc-box, .calc-worm').forEach(e=>e.remove());
      });

      const topRow=document.getElementById('numbersTop');
      const boxes=topRow.querySelectorAll('.num-box');
      if(boxes.length<2) return;

      const N = boxes.length - 1;
      for(let i=0;i<N;i++){
        let a=parseFloat(boxes[i].innerText.replace(',', '.'));
        let b=parseFloat(boxes[i+1].innerText.replace(',', '.'));
        let diff;

        if(currentGraph==='Z.Z'){
          diff = Math.abs(b-a).toFixed(1);
        } else {
          if(a>=6 && a<=9 && b===0) b=10;
          if(a===0 && b>=6 && b<=9) a=10;
          diff=Math.abs(b-a);
        }

        let c2=numColors.slice(-11)[i+1]||'red';
        if(c2==='#666') c2=numColors.slice(-11)[i]||'red';
        const isBlue=(c2==='blue');

        let rowId;
        if(currentGraph==='Z.Z'){  
          rowId=isBlue?'rowNB':'rowNR';   // sadece normal sÃ¼tunlar
        } else {
          rowId=(b<a)?(isBlue?'rowAB':'rowAR'):(isBlue?'rowNB':'rowNR');
        }

        const rowEl=document.getElementById(rowId);
        const rPrev=boxes[i].getBoundingClientRect();
        const rNext=boxes[i+1].getBoundingClientRect();
        const rRow=rowEl.getBoundingClientRect();
        const midX=(rPrev.right+rNext.left)/2;
        const leftInside=midX-rRow.left-11;

        const bubble=document.createElement('div');
        bubble.className='calc-box';
        bubble.style.left=leftInside+'px';
        bubble.style.background=isBlue?'blue':'red';
        bubble.textContent=diff;
        rowEl.appendChild(bubble);

        const wormColor=wormLinesTop.slice(-11)[i+1];
        if(wormColor==='blue' || wormColor==='red'){
          const worm=document.createElement('div');
          worm.className='calc-worm';
          worm.style.width=bubble.offsetWidth+'px';
          worm.style.left=bubble.offsetLeft+'px';
          worm.style.top=(bubble.offsetTop+bubble.offsetHeight+2)+'px';
          worm.style.borderTopColor=wormColor;
          rowEl.appendChild(worm);
        }
      }
    }

    // ðŸ”¹ GÃœNCELLENEN startWS (20 geÃ§miÅŸ tik yÃ¼klÃ¼yor)
    function startWS(){
      ws=new WebSocket('wss://ws.binaryws.com/websockets/v3?app_id=1089');
      ws.onopen=()=>{
        ws.send(JSON.stringify({ticks_history:currentPair,end:"latest",count:20,subscribe:1}));
      };
      ws.onmessage=(msg)=>{
        const d=JSON.parse(msg.data);

        if(d.history){
          d.history.prices.forEach(p=>{
            const price=parseFloat(p);
            prices.push(price);
            const lastTwo=Math.floor(price).toString().slice(-2);
            digits.push(lastTwo);
            const priceStr=price.toString();
            const dec=(priceStr.split('.')[1]||'0');
            decimalDigits.push(dec.slice(-1));
            const lastInt=Math.floor(price).toString().slice(-1);
            const firstDec=dec.charAt(0)||'0';
            combinedDigits.push(lastInt+','+firstDec);
            updateWorm();
          });
        }

        if(d.tick){
          const price=parseFloat(d.tick.quote);
          prices.push(price); if(prices.length>20) prices.shift();

          const lastTwo=Math.floor(price).toString().slice(-2);
          digits.push(lastTwo); if(digits.length>20) digits.shift();

          const priceStr=d.tick.quote.toString();
          const dec=(priceStr.split('.')[1]||'0');
          decimalDigits.push(dec.slice(-1)); if(decimalDigits.length>20) decimalDigits.shift();

          const lastInt=Math.floor(price).toString().slice(-1);
          const firstDec=dec.charAt(0)||'0';
          combinedDigits.push(lastInt+','+firstDec); if(combinedDigits.length>20) combinedDigits.shift();

          updateWorm();

          // GÃ¼ncellenen fiyat kutusunu gÃ¶ster
          const priceEl = document.getElementById('price');
          priceEl.innerText = price.toFixed(2).replace('.', ',');
          if(prices.length > 1){
            const prev = prices[prices.length-2];
            if(price > prev){
              priceEl.style.background = 'blue';
            } else if(price < prev){
              priceEl.style.background = 'red';
            } else {
              priceEl.style.background = '#999';
            }
          }
        }

        // ðŸ”¹ senin mevcut render ve grafik kodun
        const row=document.getElementById('numbersTop');
        row.innerHTML='';
        numColors=[];
        let activeArr=(currentGraph==='XZ'?decimalDigits:(currentGraph==='ZZ'?digits:combinedDigits));
        const sliceArr=activeArr.slice(-11);
        for(let i=0;i<sliceArr.length;i++){
          const globalIndex=activeArr.length-11+i;
          const up=globalIndex>0&&prices[globalIndex]>prices[globalIndex-1];
          const down=globalIndex>0&&prices[globalIndex]<prices[globalIndex-1];
          const color=up?'blue':down?'red':'#666';
          numColors.push(color);
          const box=document.createElement('div');
          box.className='num-box';
          box.style.background=color;
          box.innerText=(currentGraph==='Z.Z')?(sliceArr[i]||'').replace(',', '.'):(sliceArr[i]||'0');
          row.appendChild(box);
        }

        const last11=prices.slice(-11);
        chart.data.datasets[0].data=last11;
        chart.data.datasets[0].pointBackgroundColor=last11.map((p,i)=>{
          if(i===0) return 'gray';
          if(p>last11[i-1]) return 'blue';
          if(p<last11[i-1]) return 'red';
          return 'gray';
        });
        chart.data.datasets[0].pointBorderColor=Array(last11.length).fill('transparent');
        chart.data.labels=Array.from({length:last11.length},(_,i)=>(i+1).toString());
        chart.update();

        setTimeout(()=>{
          renderWormLines('numbersTop',wormLinesTop.slice(-11));
          renderCalcBubbles();
          placeVerticalLine();
        },40);
      };
    }

    function updateTime(){
      const now=new Date();
      const hh=now.getUTCHours().toString().padStart(2,'0');
      const mm=now.getUTCMinutes().toString().padStart(2,'0');
      const ss=now.getUTCSeconds().toString().padStart(2,'0');
      document.getElementById('time').innerText=`GMT ${hh}:${mm}:${ss}`;
    }
    setInterval(updateTime,1000);
    updateTime();
    startWS();
  </script>
</body>
</html>
